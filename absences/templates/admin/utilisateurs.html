{% extends 'base.html' %}
{% load static %}
{% block title %}Gestion des utilisateurs{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Gestion des utilisateurs</h2>

  <!-- Boutons d'action -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{% url 'dashboard_drh' %}" class="btn btn-secondary">üìä Tableau de bord</a>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">‚ûï Ajouter un utilisateur</button>
  </div>

  <!-- Tableau des utilisateurs -->
  <div class="table-responsive rounded shadow-sm">
    <table class="table table-striped table-hover align-middle mb-0" id="tableUsers">
      <thead class="table-dark">
        <tr>
          <th>Nom</th>
          <th>Pr√©nom</th>
          <th>Email</th>
          <th>R√¥le</th>
          <th>Actif</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for u in utilisateurs %}
        <tr>
          <td>{{ u.last_name }}</td>
          <td>{{ u.first_name }}</td>
          <td>{{ u.email }}</td>
          <td>{{ u.profile.get_role_display }}</td>
          <td>{{ u.profile.actif|yesno:"Oui,Non" }}</td>
          <td class="text-center">
            <!-- Info -->
            <button class="btn btn-sm btn-outline-info me-1 btn-info"
              data-user='{
                "id": "{{ u.id }}",
                "nom": "{{ u.last_name }}",
                "prenom": "{{ u.first_name }}",
                "email": "{{ u.email }}",
                "username": "{{ u.username }}",
                "poste": "{{ u.profile.poste }}",
                "role": "{{ u.profile.get_role_display }}",
                "actif": "{{ u.profile.actif|yesno:"Oui,Non" }}",
                "superieur": "{{ u.profile.superieur.get_full_name|default:"Aucun" }}"
              }'
              data-bs-toggle="modal" data-bs-target="#userInfoModal" title="Infos utilisateur">‚ÑπÔ∏è</button>

            <!-- Modifier -->
            <button class="btn btn-sm btn-outline-warning me-1 btn-edit"
              data-user='{
                "id": "{{ u.id }}",
                "nom": "{{ u.last_name }}",
                "prenom": "{{ u.first_name }}",
                "email": "{{ u.email }}",
                "username": "{{ u.username }}",
                "role": "{{ u.profile.role }}",
                "superieur": "{{ u.profile.superieur.id|default:'' }}",
                "actif": "{{ u.profile.actif }}"
              }'
              data-bs-toggle="modal" data-bs-target="#editUserModal" title="Modifier">‚úèÔ∏è</button>

            <!-- Supprimer -->
            <button class="btn btn-sm btn-outline-danger" 
              onclick="openDeleteModal({{ u.id }}, '{{ u.get_full_name }}')" title="Supprimer">üóëÔ∏è</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modales -->

<!-- ‚úÖ Modal Ajouter Utilisateur -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form method="POST" class="modal-content rounded-3 shadow-sm">
      {% csrf_token %}
      <input type="hidden" name="action" value="create">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">‚ûï Ajouter un utilisateur</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-3">
        <!-- Champs formulaire -->
        <div class="col-md-6">
          <label>Nom</label>
          <input type="text" name="last_name" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label>Pr√©nom</label>
          <input type="text" name="first_name" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label>Email</label>
          <input type="email" name="email" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label>Nom d'utilisateur</label>
          <input type="text" name="username" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label>R√¥le</label>
          <select name="role" class="form-select" required>
            {% for key, val in roles.items %}
              <option value="{{ key }}">{{ val }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label>Sup√©rieur hi√©rarchique</label>
          <select name="superieur" class="form-select">
            <option value="">Aucun</option>
            {% for s in sup√©rieurs %}
              <option value="{{ s.id }}">{{ s.get_full_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label>Poste</label>
          <input type="text" name="poste" class="form-control">
        </div>
        <div class="col-md-6 d-flex align-items-center">
          <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" name="actif" checked>
            <label class="form-check-label">Actif</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Ajouter</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚úèÔ∏è Modal Modifier Utilisateur -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form method="POST" class="modal-content rounded-3 shadow-sm">
      {% csrf_token %}
      <input type="hidden" name="action" value="edit">
      <input type="hidden" name="user_id" id="edit_user_id">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">‚úèÔ∏è Modifier l‚Äôutilisateur</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-3">
        <div class="col-md-6">
          <label>Nom</label>
          <input type="text" id="edit_nom" name="last_name" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label>Pr√©nom</label>
          <input type="text" id="edit_prenom" name="first_name" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label>Email</label>
          <input type="email" id="edit_email" name="email" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label>Nom d'utilisateur</label>
          <input type="text" id="edit_username" name="username" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label>R√¥le</label>
          <select id="edit_role" name="role" class="form-select" required>
            {% for key, val in roles.items %}
              <option value="{{ key }}">{{ val }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label>Sup√©rieur hi√©rarchique</label>
          <select id="edit_superieur" name="superieur" class="form-select">
            <option value="">Aucun</option>
            {% for s in sup√©rieurs %}
              <option value="{{ s.id }}">{{ s.get_full_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label>Poste</label>
          <input type="text" id="edit_poste" name="poste" class="form-control">
        </div>
        <div class="col-md-6 d-flex align-items-center">
          <div class="form-check mt-4">
            <input id="edit_actif" class="form-check-input" type="checkbox" name="actif">
            <label class="form-check-label">Actif</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-warning">Enregistrer</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
      </div>
    </form>
  </div>
</div>

<!-- üóëÔ∏è Modal Supprimer Utilisateur -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" class="modal-content rounded-3 shadow-sm">
      {% csrf_token %}
      <input type="hidden" name="action" value="delete">
      <input type="hidden" name="user_id" id="delete_user_id">
      <div class="modal-header">
        <h5 class="modal-title text-danger fw-bold">üóëÔ∏è Supprimer un utilisateur</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">√ätes-vous s√ªr de vouloir supprimer <strong id="delete_user_name"></strong> ?</p>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-danger">Oui, supprimer</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚ÑπÔ∏è Modal Infos Utilisateur -->
<div class="modal fade" id="userInfoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3 shadow-sm">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">‚ÑπÔ∏è Informations de l'utilisateur</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>Nom :</strong> <span id="info_nom"></span></li>
          <li class="list-group-item"><strong>Pr√©nom :</strong> <span id="info_prenom"></span></li>
          <li class="list-group-item"><strong>Email :</strong> <span id="info_email"></span></li>
          <li class="list-group-item"><strong>Nom d'utilisateur :</strong> <span id="info_username"></span></li>
          <li class="list-group-item"><strong>Poste :</strong> <span id="info_poste"></span></li>
          <li class="list-group-item"><strong>R√¥le :</strong> <span id="info_role"></span></li>
          <li class="list-group-item"><strong>Statut :</strong> <span id="info_actif"></span></li>
          <li class="list-group-item"><strong>Sup√©rieur hi√©rarchique :</strong> <span id="info_superieur"></span></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- DataTables CSS & JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
  $('#tableUsers').DataTable({
    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json' },
    pageLength: 10,
    lengthMenu: [5, 10, 25, 50, 100],
    ordering: true
  });
});

// Modales : Edit / Delete / Info
document.querySelectorAll('.btn-edit').forEach(btn => {
  btn.addEventListener('click', () => {
    const user = JSON.parse(btn.getAttribute('data-user'));
    document.getElementById('edit_user_id').value = user.id;
    document.getElementById('edit_nom').value = user.nom;
    document.getElementById('edit_prenom').value = user.prenom;
    document.getElementById('edit_email').value = user.email;
    document.getElementById('edit_username').value = user.username;
    document.getElementById('edit_role').value = user.role;
    document.getElementById('edit_superieur').value = user.superieur;
    document.getElementById('edit_actif').checked = user.actif === "True";
  });
});

function openDeleteModal(id, name) {
  document.getElementById('delete_user_id').value = id;
  document.getElementById('delete_user_name').textContent = name;
  new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
}

document.querySelectorAll('.btn-info').forEach(btn => {
  btn.addEventListener('click', () => {
    const user = JSON.parse(btn.getAttribute('data-user'));
    document.getElementById('info_nom').textContent = user.nom;
    document.getElementById('info_prenom').textContent = user.prenom;
    document.getElementById('info_email').textContent = user.email;
    document.getElementById('info_username').textContent = user.username;
    document.getElementById('info_poste').textContent = user.poste || 'Non pr√©cis√©';
    document.getElementById('info_role').textContent = user.role;
    document.getElementById('info_actif').textContent = user.actif;
    document.getElementById('info_superieur').textContent = user.superieur;
  });
});
</script>
{% endblock %}
