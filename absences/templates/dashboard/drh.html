{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard DRH{% endblock %}

{% block content %}

<div class="container-fluid py-4">

  <!-- ================================================= -->
<!-- MINI INDICATEURS DRH -->
<!-- ================================================= -->
<div class="row g-3 mb-4">

  <!-- EN ATTENTE -->
  <div class="col-12 col-md-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">Demandes en attente</div>
          <h3 class="fw-bold mb-0">
            {{ nb_en_attente }}
          </h3>
        </div>
        <div class="fs-1 text-secondary">‚è≥</div>
      </div>
    </div>
  </div>

  <!-- VALID√âES -->
  <div class="col-12 col-md-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">Absences valid√©es</div>
          <h3 class="fw-bold mb-0 text-success">
            {{ nb_validees }}
          </h3>
        </div>
        <div class="fs-1 text-success">‚úÖ</div>
      </div>
    </div>
  </div>

  <!-- REJET√âES / ANNUL√âES -->
  <div class="col-12 col-md-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">Rejet√©es / annul√©es</div>
          <h3 class="fw-bold mb-0 text-danger">
          {{ nb_annulees }}
        </h3>
        </div>
        <div class="fs-1 text-danger">‚ùå</div>
      </div>
    </div>
  </div>

</div>


<!-- ================================================= -->
<!-- HEADER -->
<!-- ================================================= -->
<div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
  <div>
    <h2 class="fw-bold mb-1">üìã Tableau de bord ‚Äì DRH</h2>
    <p class="text-muted mb-0">
      Validation, suivi et gestion RH
    </p>
  </div>

  <div class="d-flex gap-2 mt-3 mt-md-0">
    <a href="{% url 'configuration_view' %}" class="btn btn-outline-secondary">
      ‚öôÔ∏è Configuration
    </a>
    <a href="{% url 'admin_users' %}" class="btn btn-primary">
      üë• Utilisateurs
    </a>
  </div>
</div>

<!-- ================================================= -->
<!-- TABS -->
<!-- ================================================= -->
<div class="card shadow-sm">
  <div class="card-header bg-white">
    <ul class="nav nav-tabs card-header-tabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#demandes">üì• Demandes RH</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#superieur">
          üëî Mes validations hi√©rarchiques
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#suivi">üìä Suivi & Historique</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#quotas">üìà Quotas</a>
      </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#conges-annuels">
        üèñÔ∏è Cong√©s annuels
      </a>
    </li>

      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#recups">üîÑ R√©cup√©rations</a>
      </li>
    </ul>
  </div>

  <div class="card-body tab-content">

<!-- ================================================= -->
<!-- DEMANDES RH -->
<!-- ================================================= -->
<div class="tab-pane fade show active" id="demandes">

<div class="table-responsive">
<table class="table table-hover align-middle">
<thead class="table-light">
<tr>
  <th>Collaborateur</th>
  <th>Type</th>
  <th>P√©riode</th>
  <th>Jours</th>
  <th class="text-end">Actions</th>
</tr>
</thead>
<tbody>

{% for a in absences_a_verifier %}
<tr>
  <td class="fw-semibold">{{ a.collaborateur.get_full_name }}</td>
  <td>{{ a.type_absence.nom }}</td>
  <td>
    <small class="text-muted">
      {{ a.date_debut }} ‚Üí {{ a.date_fin }}
    </small>
  </td>
  <td>
    <span class="badge bg-info">{{ a.nombre_jours }} j</span>
  </td>
  <td class="text-end">
    <button class="btn btn-success btn-sm"
      data-bs-toggle="modal" data-bs-target="#verifier{{ a.id }}">
      ‚úî
    </button>
    <button class="btn btn-outline-danger btn-sm"
      data-bs-toggle="modal" data-bs-target="#rejeter{{ a.id }}">
      ‚úñ
    </button>
  </td>
</tr>
{% empty %}
<tr>
  <td colspan="5" class="text-center text-muted py-4">
    Aucune demande en attente
  </td>
</tr>
{% endfor %}

</tbody>
</table>
</div>
</div>

<!-- ================================================= -->
<!-- SUIVI & HISTORIQUE -->
<!-- ================================================= -->
<div class="tab-pane fade" id="suivi">

<form method="get" class="row g-2 mb-4">
  <div class="col-md-3">
    <select name="mois" class="form-select">
      <option value="">üìÖ Mois</option>
      {% for i,m in mois_list %}
        <option value="{{ i }}" {% if mois_selectionne == i %}selected{% endif %}>
          {{ m }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <select name="type" class="form-select">
      <option value="">üè∑Ô∏è Type</option>
      {% for t in types %}
        <option value="{{ t.id }}" {% if type_selectionne == t.id %}selected{% endif %}>
          {{ t.nom }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <select name="statut" class="form-select">
      <option value="">‚öôÔ∏è Statut</option>
      {% for k,v in absence_statuts %}
        <option value="{{ k }}" {% if statut_selectionne == k %}selected{% endif %}>
          {{ v }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <button class="btn btn-primary w-100">üîç Filtrer</button>
  </div>
</form>

<div class="table-responsive">
<table class="table table-hover align-middle">
<thead class="table-light">
<tr>
  <th>Collaborateur</th>
  <th>Soumise le</th>
  <th>Type</th>
  <th>P√©riode</th>
  <th>Statut</th>
  <th>Historique</th>
  <th>Action DRH</th>
</tr>
</thead>
<tbody>

{% for a in absences %}
<tr>
  <td>{{ a.collaborateur.get_full_name }}</td>
  <td>{{ a.date_creation|date:"d/m/Y H:i" }}</td>
  <td>{{ a.type_absence.nom }}</td>
  <td>{{ a.date_debut }} ‚Üí {{ a.date_fin }}</td>
  <td>{{ a.get_statut_display }}</td>
  <td>
    <button class="btn btn-outline-info btn-sm"
      data-bs-toggle="modal" data-bs-target="#hist{{ a.id }}">
      üìú
    </button>
  </td>
  <td>
    {% if a.statut == 'valide_dp' %}
    <button class="btn btn-outline-danger btn-sm"
      data-bs-toggle="modal" data-bs-target="#annuler{{ a.id }}">
      ‚ùå Annuler
    </button>
    {% else %}
    ‚Äî
    {% endif %}
  </td>
</tr>
{% empty %}
<tr>
  <td colspan="7" class="text-center text-muted py-4">
    Aucune absence
  </td>
</tr>
{% endfor %}

</tbody>
</table>
</div>
</div>

<!-- ================================================= -->
<!-- QUOTAS -->
<!-- ================================================= -->
<div class="tab-pane fade" id="quotas">

{% if request.user.profile.role == 'drh' %}
<div class="alert alert-warning d-flex justify-content-between align-items-center">
  <div>
    <strong>üîÑ Report annuel des quotas</strong><br>
    <small class="text-muted">
      Reporter automatiquement les quotas restants
    </small>
  </div>

  <form method="post" action="{% url 'reporter_quotas' %}">
    {% csrf_token %}
    <button class="btn btn-warning"
      onclick="return confirm('√ätes-vous s√ªr de vouloir reporter les quotas ?');">
      Lancer
    </button>
  </form>
</div>
{% endif %}

<div class="table-responsive">
<table class="table table-bordered align-middle">
<thead class="table-light">
<tr>
  <th>Collaborateur</th>
  {% for t in types %}
    <th class="text-center">{{ t.nom }}</th>
  {% endfor %}
</tr>
</thead>
<tbody>

{% for row in quota_rows %}
<tr>
  <td class="fw-semibold">{{ row.user.get_full_name }}</td>

    {% for item in row.quotas %}
    <td class="text-center">
      <strong>
    {% if item.quota %}
      {{ item.quota.jours_disponibles }}
    {% else %}
      0
    {% endif %}
  </strong>


    <div class="d-inline-flex ms-2">
      <button class="btn btn-success btn-sm me-1"
        data-bs-toggle="modal"
        data-bs-target="#modalQuota"
        data-user="{{ row.user.id }}"
        data-type="{{ item.type.id }}"
        data-operation="ajouter">+</button>

      <button class="btn btn-danger btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#modalQuota"
        data-user="{{ row.user.id }}"
        data-type="{{ item.type.id }}"
        data-operation="reduire">‚àí</button>
    </div>
  </td>
  {% endfor %}
</tr>
{% endfor %}

</tbody>
</table>
</div>
</div>

<!-- ================================================= -->
<!-- CONG√âS ANNUELS 2025 / 2026 -->
<!-- ================================================= -->
<div class="tab-pane fade" id="conges-annuels">

<div class="table-responsive">
<table class="table table-bordered align-middle">
  <thead class="table-light">
    <tr>
      <th>Collaborateur</th>
      <th class="text-center">Cong√© annuel 2025</th>
      <th class="text-center">Cong√© annuel 2026</th>
    </tr>
  </thead>

  <tbody>
  {% for row in conges_annuels_rows %}
    <tr>
      <td class="fw-semibold">{{ row.user.get_full_name }}</td>
      <td class="text-center">
        <span class="badge bg-info">{{ row.2025 }} j</span>
      </td>
      <td class="text-center">
        <span class="badge bg-success">{{ row.2026 }} j</span>
      </td>
    </tr>
  {% empty %}
    <tr>
      <td colspan="3" class="text-center text-muted py-4">
        Aucun quota disponible
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
</div>

</div>

<!-- ================================================= -->
<!-- DEMANDES COMME SUP√âRIEUR HI√âRARCHIQUE -->
<!-- ================================================= -->
<div class="tab-pane fade" id="superieur">

<div class="table-responsive">
<table class="table table-hover align-middle">
<thead class="table-light">
<tr>
  <th>Collaborateur</th>
  <th>Type</th>
  <th>P√©riode</th>
  <th>Jours</th>
  <th class="text-end">Action</th>
</tr>
</thead>
<tbody>

{% for a in absences_comme_superieur %}
<tr>
  <td class="fw-semibold">{{ a.collaborateur.get_full_name }}</td>
  <td>{{ a.type_absence.nom }}</td>
  <td>{{ a.date_debut }} ‚Üí {{ a.date_fin }}</td>
  <td><span class="badge bg-info">{{ a.nombre_jours }} j</span></td>
  <td class="text-end">
    <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="absence_id" value="{{ a.id }}">
                <button name="decision" value="valider" class="btn btn-success btn-sm">Valider</button>
              </form>

              <!-- Rejeter -->
              <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalRejet{{ a.id }}">Rejeter</button>

              <!-- Historique -->
              <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#modalHistorique{{ a.id }}">Historique</button>

              <!-- Modal Rejet -->
              <div class="modal fade" id="modalRejet{{ a.id }}" tabindex="-1">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="absence_id" value="{{ a.id }}">
                      <input type="hidden" name="decision" value="rejeter">
                      <div class="modal-header">
                        <h5 class="modal-title">Motif du rejet</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <textarea name="motif" class="form-control" required></textarea>
                      </div>
                      <div class="modal-footer">
                        <button type="submit" class="btn btn-danger">Confirmer</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Modal Historique -->
              <div class="modal fade" id="modalHistorique{{ a.id }}" tabindex="-1">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Historique de l'absence</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <ul>
                        {% for h in a.historiques.all %}
                        <li>
                          {{ h.date_validation|date:"d/m/Y H:i" }} ‚Äî {{ h.role_valide }} :
                          {{ h.decision|title }}{% if h.motif %} (Motif : {{ h.motif }}){% endif %}
                        </li>
                        {% empty %}
                        <li>Aucun historique</li>
                        {% endfor %}
                      </ul>
                    </div>
                    <div class="modal-footer">
                      <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    </div>
                  </div>
                </div>
              </div>

            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="text-center">Aucune absence √† valider.</td></tr>
          {% endfor %}

</tbody>
</table>
</div>
</div>

<!-- ================================================= -->
<!-- RECUPERATIONS -->
<!-- ================================================= -->
<div class="tab-pane fade" id="recups">

<div class="table-responsive">
<table class="table table-hover align-middle">
<thead class="table-light">
<tr>
  <th>Collaborateur</th>
  <th>Date</th>
  <th>Jours</th>
  <th>Motif</th>
  <th class="text-end">Action</th>
</tr>
</thead>
<tbody>

{% for r in recuperations %}
<tr>
  <td>{{ r.utilisateur.get_full_name }}</td>
  <td>{{ r.date_debut }}</td>
  <td>{{ r.nombre_jours }}</td>
   <td>{{ r.motif }}</td>
  <td class="text-end">
    {% if r.statut == 'en_attente' %}
    <button class="btn btn-success btn-sm"
      data-bs-toggle="modal"
      data-bs-target="#verifierRecup{{ r.id }}">
      ‚úî V√©rifier
    </button>
    {% else %}
    ‚Äî
    {% endif %}
  </td>
</tr>
{% empty %}
<tr>
  <td colspan="5" class="text-center text-muted py-4">
    Aucune r√©cup√©ration
  </td>
</tr>
{% endfor %}

</tbody>
</table>
</div>
</div>

</div> <!-- card-body -->
</div> <!-- card -->
</div> <!-- container -->

<!-- ================================================= -->
<!-- üîÅ MODALES (INCHANG√âES ‚Äì TON CODE) -->
<!-- ================================================= -->
{% for r in recuperations %}
<div class="modal fade" id="verifierRecup{{ r.id }}" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" action="{% url 'valider_recuperation' r.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üîÑ V√©rifier la r√©cup√©ration</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p class="mb-2">
            <strong>{{ r.utilisateur.get_full_name }}</strong>
          </p>
          <ul class="list-group list-group-flush mb-3">
            <li class="list-group-item">üìÖ Date : {{ r.date_debut }}</li>
            <li class="list-group-item">‚è± Jours : {{ r.nombre_jours }}</li>
            <li class="list-group-item">üìù Motif : {{ r.motif }}</li>
          </ul>

          <div class="alert alert-info mb-0">
            Cette action transmet la r√©cup√©ration au Directeur Pays.
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-success">‚úî Confirmer</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Annuler
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endfor %}
{% for a in absences_a_verifier %}

<!-- ‚úî V√©rifier -->
<div class="modal fade" id="verifier{{ a.id }}" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" action="{% url 'verifier_absence' a.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‚úî V√©rifier l‚Äôabsence</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p class="fw-semibold mb-1">{{ a.collaborateur.get_full_name }}</p>
          <p class="mb-0">      
            <small class="text-muted">
              {{ a.date_debut }} ‚Üí {{ a.date_fin }}
            </small>
          </p>
             <p class="mb-0">
            Quota restant :
                {% if a.quota_total_restant is not None %}
                  {{ a.quota_total_restant }}
                {% else %}
                  0
                {% endif %}
                jours {{ a.type_absence.nom }}
 <br>
          </p>

        </div>

        <div class="modal-footer">
          <button class="btn btn-success">Confirmer</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Annuler
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ‚ùå Rejeter -->
<div class="modal fade" id="rejeter{{ a.id }}" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" action="{% url 'rejeter_absence_drh' a.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‚ùå Rejeter l‚Äôabsence</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <label class="form-label">Motif du rejet</label>
          <textarea name="commentaire" class="form-control" rows="4" required></textarea>
        </div>

        <div class="modal-footer">
          <button class="btn btn-danger">Rejeter</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endfor %}
{% for a in absences %}
<div class="modal fade" id="hist{{ a.id }}" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìú Historique des validations</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <ul class="list-group">
          {% for h in a.historiques.all %}
          <li class="list-group-item">
            <strong>{{ h.date_validation|date:"d/m/Y H:i" }}</strong>
            ‚Äî {{ h.decision }}
            <br>
            <small class="text-muted">
              {{ h.utilisateur.get_full_name }} ‚Ä¢ {{ h.motif }}
            </small>
          </li>
          {% empty %}
          <li class="list-group-item text-center text-muted">
            Aucun historique
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% for a in absences %}
<div class="modal fade" id="annuler{{ a.id }}" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" action="{% url 'annuler_absence_drh' a.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‚ùå Annulation DRH</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <label class="form-label">Motif de l‚Äôannulation</label>
          <textarea name="motif" class="form-control" rows="4" required></textarea>

          <div class="alert alert-warning mt-3 mb-0">
            ‚ö†Ô∏è Suppression d√©finitive de l‚Äôabsence et restauration du quota.
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-danger">Confirmer</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endfor %}
<div class="modal fade" id="modalQuota" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" action="{% url 'ajuster_quota' %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ajuster le quota</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="user_id" id="quotaUser">
          <input type="hidden" name="type_id" id="quotaType">
          <input type="hidden" name="operation" id="quotaOperation">

          <label class="form-label">Nombre de jours</label>
          <input type="number" name="jours" class="form-control" step="0.5" min="0.5" required>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary">Confirmer</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Annuler
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const modal = document.getElementById('modalQuota');
  if (!modal) return;

  modal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    document.getElementById('quotaUser').value = button.dataset.user;
    document.getElementById('quotaType').value = button.dataset.type;
    document.getElementById('quotaOperation').value = button.dataset.operation;

    this.querySelector('.modal-title').textContent =
      button.dataset.operation === 'ajouter'
      ? 'Ajouter des jours au quota'
      : 'R√©duire des jours du quota';
  });
});
</script>



{% endblock %}
