{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard DRH{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

<h2 class="mb-3">üìã Tableau de bord ‚Äì DRH</h2>

<a href="{% url 'configuration_view' %}" class="btn btn-outline-info">‚öôÔ∏è Configuration</a>
<a href="{% url 'admin_users' %}" class="btn btn-outline-primary">üë• G√©rer les utilisateurs</a>

<hr>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#demandes">üì• Demandes RH</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#suivi">üìä Suivi & Historique</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#quotas">üìà Quotas</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#recups">üîÑ R√©cup√©rations</a></li>
</ul>

<div class="tab-content">

<!-- ================================================= -->
<!-- DEMANDES RH -->
<!-- ================================================= -->
<div class="tab-pane fade show active" id="demandes">

<table class="table table-bordered table-sm">
<thead class="table-light">
<tr>
  <th>Collaborateur</th>
  <th>Type</th>
  <th>Dates</th>
  <th>Jours</th>
  <th>Actions</th>
</tr>
</thead>
<tbody>

{% for a in absences_a_verifier %}
<tr>
<td>{{ a.collaborateur.get_full_name }}</td>
<td>{{ a.type_absence.nom }}</td>
<td>{{ a.date_debut }} ‚Üí {{ a.date_fin }}</td>
<td>{{ a.nombre_jours }}</td>
<td>
  <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#verifier{{ a.id }}">‚úî V√©rifier</button>
  <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#rejeter{{ a.id }}">‚úñ Rejeter</button>
</td>
</tr>
{% empty %}
<tr><td colspan="5" class="text-center">Aucune demande en attente</td></tr>
{% endfor %}

</tbody>
</table>
</div>

<!-- ================================================= -->
<!-- SUIVI & HISTORIQUE -->
<!-- ================================================= -->
<div class="tab-pane fade" id="suivi">

<form method="get" class="row g-3 mb-3">
  <div class="col-md-3">
    <select name="mois" class="form-select">
      <option value="">Mois</option>
      {% for i,m in mois_list %}
        <option value="{{ i }}" {% if mois_selectionne == i %}selected{% endif %}>{{ m }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <select name="type" class="form-select">
      <option value="">Type</option>
      {% for t in types %}
        <option value="{{ t.id }}" {% if type_selectionne == t.id %}selected{% endif %}>{{ t.nom }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <select name="statut" class="form-select">
      <option value="">Statut</option>
      {% for k,v in absence_statuts %}
        <option value="{{ k }}" {% if statut_selectionne == k %}selected{% endif %}>{{ v }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <button class="btn btn-primary w-100">Filtrer</button>
  </div>
</form>

<table class="table table-sm table-hover">
<thead class="table-light">
<tr>
  <th>Collaborateur</th>
  <th>Soumise le</th>
  <th>Type</th>
  <th>Dates</th>
  <th>Statut</th>
  <th>Historique</th>
  <th>Action DRH</th>
</tr>
</thead>
<tbody>

{% for a in absences %}
<tr>
<td>{{ a.collaborateur.get_full_name }}</td>
<td>{{ a.date_creation|date:"d/m/Y H:i" }}</td>
<td>{{ a.type_absence.nom }}</td>
<td>{{ a.date_debut }} ‚Üí {{ a.date_fin }}</td>
<td>{{ a.get_statut_display }}</td>

<td>
<button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#hist{{ a.id }}">üìú</button>
</td>

<td>
{% if a.statut == 'valide_dp' %}
<button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#annuler{{ a.id }}">‚ùå Annuler</button>
{% else %}
‚Äî
{% endif %}
</td>
</tr>

{% empty %}
<tr><td colspan="7" class="text-center">Aucune absence</td></tr>
{% endfor %}
</tbody>
</table>
</div>

<!-- ================================================= -->
<!-- QUOTAS -->
<!-- ================================================= -->
<div class="tab-pane fade" id="quotas">
<table class="table table-bordered table-sm">
<thead class="table-light">
<tr>
<th>Collaborateur</th>
{% for t in types %}<th>{{ t.nom }}</th>{% endfor %}
</tr>
</thead>
<tbody>

{% for row in quota_rows %}
<tr>
<td>{{ row.user.get_full_name }}</td>

{% for item in row.quotas %}
<td class="text-center">
<strong>{{ item.quota.jours_disponibles|default:0 }}</strong>

<button
  class="btn btn-success btn-sm ms-1"
  data-bs-toggle="modal"
  data-bs-target="#modalQuota"
  data-user="{{ row.user.id }}"
  data-type="{{ item.type.id }}"
  data-operation="ajouter">
  +
</button>

<button
  class="btn btn-danger btn-sm ms-1"
  data-bs-toggle="modal"
  data-bs-target="#modalQuota"
  data-user="{{ row.user.id }}"
  data-type="{{ item.type.id }}"
  data-operation="reduire">
  ‚àí
</button>

</td>
{% endfor %}
</tr>
{% endfor %}

</tbody>
</table>
</div>

<!-- ================================================= -->
<!-- RECUPERATIONS -->
<!-- ================================================= -->
<div class="tab-pane fade" id="recups">
<table class="table table-bordered table-sm">
<thead class="table-light">
<tr>
<th>Collaborateur</th>
<th>Date</th>
<th>Jours</th>
<th>Statut</th>
</tr>
</thead>
<tbody>
{% for r in recuperations %}
<tr>
<td>{{ r.utilisateur.get_full_name }}</td>
<td>{{ r.date_debut }}</td>
<td>{{ r.nombre_jours }}</td>
<td>{{ r.statut }}</td>

<td>
  {% if r.statut == 'en_attente' %}
    <button
      class="btn btn-success btn-sm"
      data-bs-toggle="modal"
      data-bs-target="#verifierRecup{{ r.id }}">
      ‚úî V√©rifier
    </button>
  {% else %}
    ‚Äî
  {% endif %}
</td>

</tr>
{% empty %}
<tr><td colspan="4" class="text-center">Aucune r√©cup√©ration</td></tr>
{% endfor %}
</tbody>
</table>
</div>

</div>
</div>

{% for r in recuperations %}
<div class="modal fade" id="verifierRecup{{ r.id }}" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="{% url 'valider_recuperation' r.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">V√©rifier la r√©cup√©ration (RH)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p>
            <strong>{{ r.utilisateur.get_full_name }}</strong><br>
            Date : {{ r.date_debut }}<br>
            Nombre de jours : {{ r.nombre_jours }}<br>
            Motif : {{ r.motif }}
          </p>

          <div class="alert alert-info">
            Cette action confirme la r√©cup√©ration et la transmet au Directeur Pays.
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-success">‚úî Confirmer</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Annuler
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endfor %}


<!-- ================================================= -->
<!-- ===================== MODALES ==================== -->
<!-- ================================================= -->

{% for a in absences_a_verifier %}
<div class="modal fade" id="verifier{{ a.id }}">
<div class="modal-dialog">
<form method="post" action="{% url 'verifier_absence' a.id %}">
{% csrf_token %}
<div class="modal-content">
<div class="modal-header"><h5>V√©rifier l‚Äôabsence</h5></div>
<div class="modal-body">
<strong>{{ a.collaborateur.get_full_name }}</strong><br>
{{ a.type_absence.nom }}<br>
{{ a.date_debut }} ‚Üí {{ a.date_fin }}
</div>
<div class="modal-footer">
<button class="btn btn-success">‚úî Confirmer</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
</div>
</div>
</form>
</div>
</div>

<div class="modal fade" id="rejeter{{ a.id }}">
<div class="modal-dialog">
<form method="post" action="{% url 'rejeter_absence_drh' a.id %}">
{% csrf_token %}
<div class="modal-content">
<div class="modal-header"><h5>Rejeter l‚Äôabsence</h5></div>
<div class="modal-body">
<textarea name="commentaire" class="form-control" required></textarea>
</div>
<div class="modal-footer">
<button class="btn btn-danger">Rejeter</button>
</div>
</div>
</form>
</div>
</div>
{% endfor %}

{% for a in absences %}
<div class="modal fade" id="hist{{ a.id }}">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header"><h5>Historique</h5></div>
<div class="modal-body">
<ul class="list-group">
{% for h in a.historiques.all %}
<li class="list-group-item">
<strong>{{ h.date_validation|date:"d/m/Y H:i" }}</strong> ‚Äî
{{ h.decision }} ({{ h.utilisateur.get_full_name }})<br>
<small>{{ h.motif }}</small>
</li>
{% endfor %}
</ul>
</div>
</div>
</div>
</div>

<div class="modal fade" id="annuler{{ a.id }}">
<div class="modal-dialog">
<form method="post" action="{% url 'annuler_absence_drh' a.id %}">
{% csrf_token %}
<div class="modal-content">
<div class="modal-header"><h5>Annulation DRH</h5></div>
<div class="modal-body">
<textarea name="motif" class="form-control" required></textarea>
<div class="alert alert-warning mt-2">
Suppression d√©finitive + restauration du quota
</div>
</div>
<div class="modal-footer">
<button class="btn btn-danger">Confirmer</button>
</div>
</div>
</form>
</div>
</div>
{% endfor %}

<div class="modal fade" id="modalQuota" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="{% url 'ajuster_quota' %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ajuster le quota</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="user_id" id="quotaUser">
          <input type="hidden" name="type_id" id="quotaType">
          <input type="hidden" name="operation" id="quotaOperation">

          <label class="form-label">Nombre de jours</label>
          <input
            type="number"
            name="jours"
            class="form-control"
            step="0.5"
            min="0.5"
          >
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">
            Confirmer
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Annuler
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.getElementById('modalQuota').addEventListener('show.bs.modal', function (event) {
  const button = event.relatedTarget;

  document.getElementById('quotaUser').value = button.getAttribute('data-user');
  document.getElementById('quotaType').value = button.getAttribute('data-type');
  document.getElementById('quotaOperation').value = button.getAttribute('data-operation');

  const title = button.getAttribute('data-operation') === 'ajouter'
    ? 'Ajouter des jours au quota'
    : 'R√©duire des jours du quota';

  this.querySelector('.modal-title').textContent = title;
});
</script>


{% endblock %}
