{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard DRH{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
<h2 class="mb-4">ğŸ“‹ Tableau de bord â€“ DRH</h2>

<a href="{% url 'configuration_view' %}" class="btn btn-outline-info">âš™ï¸ Configuration</a>
<a href="{% url 'admin_users' %}" class="btn btn-outline-primary">ğŸ‘¥ GÃ©rer les utilisateurs</a>
<br><br>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#demandes">ğŸ“¥ Demandes RH</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#suivi">ğŸ“Š Suivi & Historique</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#collabs">ğŸ§‘â€ğŸ’¼ Collaborateurs</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#quotas">ğŸ“ˆ Quotas</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#recups">ğŸ”„ RÃ©cupÃ©rations</a></li>
</ul>

<div class="tab-content">

<!-- ================================================= -->
<!-- DEMANDES RH -->
<!-- ================================================= -->
<div class="tab-pane fade show active" id="demandes">
<table class="table table-bordered table-sm">
<thead class="table-light">
<tr>
  <th>Nom</th><th>Type</th><th>Dates</th><th>Jours</th><th>Actions</th>
</tr>
</thead>
<tbody>
{% for absence in absences_a_verifier %}
<tr>
<td>{{ absence.collaborateur.get_full_name }}</td>
<td>{{ absence.type_absence.nom }}</td>
<td>{{ absence.date_debut }} â†’ {{ absence.date_fin }}</td>
<td>{{ absence.nombre_jours }}</td>
<td>
  <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalVerifier{{ absence.id }}">VÃ©rifier</button>
  <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalAmeliorer{{ absence.id }}">AmÃ©liorer</button>
  <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalRejeter{{ absence.id }}">Rejeter</button>
</td>
</tr>
{% empty %}
<tr><td colspan="5" class="text-center">Aucune demande en attente.</td></tr>
{% endfor %}
</tbody>
</table>
</div>

<!-- ================================================= -->
<!-- SUIVI & HISTORIQUE (FUSION FILTRES + HISTO) -->
<!-- ================================================= -->
<div class="tab-pane fade" id="suivi">

<form method="get" class="row g-3 mb-3">
  <div class="col-md-3">
    <select name="mois" class="form-select">
      <option value="">Mois</option>
      {% for i,m in mois_list %}
        <option value="{{ i }}" {% if mois_selectionne == i %}selected{% endif %}>{{ m }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <select name="type" class="form-select">
      <option value="">Type</option>
      {% for t in types %}
        <option value="{{ t.id }}" {% if type_selectionne == t.id %}selected{% endif %}>{{ t.nom }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <select name="statut" class="form-select">
      <option value="">Statut</option>
      {% for k,v in absence_statuts %}
        <option value="{{ k }}" {% if statut_selectionne == k %}selected{% endif %}>{{ v }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <button class="btn btn-primary w-100">Filtrer</button>
  </div>
</form>

<table class="table table-sm table-hover">
<thead class="table-light">
<tr>
  <th>Nom</th>
  <th>Type</th>
  <th>Dates</th>
  <th>Statut</th>
  <th>Historique</th>
  <th>Action</th>
</tr>

</thead>
<tbody>
{% for a in absences %}
<tr>
<td>{{ a.collaborateur.get_full_name }}</td>
<td>{{ a.type_absence.nom }}</td>
<td>{{ a.date_debut }} â†’ {{ a.date_fin }}</td>
<td>{{ a.get_statut_display }}</td>
<td>
  <button class="btn btn-outline-info btn-sm"
          data-bs-toggle="modal"
          data-bs-target="#hist{{ a.id }}">
    Voir
  </button>
</td>

<td>
{% if a.statut == 'valide_dp' %}
  <button class="btn btn-outline-danger btn-sm"
          data-bs-toggle="modal"
          data-bs-target="#modalAnnulerDrh{{ a.id }}">
    âŒ Annuler (DRH)
  </button>
{% else %}
  â€”
{% endif %}
</td>

</tr>

<div class="modal fade" id="hist{{ a.id }}">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header"><h5>Historique</h5></div>
<div class="modal-body">
<ul class="list-group">
{% for h in a.historiques.all %}
<li class="list-group-item">
<strong>{{ h.date_validation|date:"d/m/Y H:i" }}</strong> â€” {{ h.decision }} ({{ h.utilisateur.get_full_name }})<br>
<small>{{ h.motif }}</small>
</li>
{% endfor %}
</ul>
</div>
</div>
</div>
</div>
{% empty %}
<tr><td colspan="5" class="text-center">Aucune absence.</td></tr>
{% endfor %}
</tbody>
</table>
</div>

<!-- ================================================= -->
<!-- COLLABORATEURS / ANNULATION DRH -->
<!-- ================================================= -->
<div class="tab-pane fade" id="collabs">
<table class="table table-bordered table-sm">
<thead class="table-light">
<tr><th>Nom</th><th>Type</th><th>Dates</th><th>Statut</th><th>Action</th></tr>
</thead>
<tbody>
{% for absence in absences %}
<tr>
<td>{{ absence.collaborateur.get_full_name }}</td>
<td>{{ absence.type_absence.nom }}</td>
<td>{{ absence.date_debut }} â†’ {{ absence.date_fin }}</td>
<td>{{ absence.get_statut_display }}</td>
<td>
{% if absence.statut == 'valide_dp' %}
<button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal"
        data-bs-target="#modalAnnulerDrh{{ absence.id }}">
âŒ Annuler (DRH)
</button>
{% else %}
â€”
{% endif %}
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<!-- ================================================= -->
<!-- QUOTAS -->
<!-- ================================================= -->
<div class="tab-pane fade" id="quotas">
<table class="table table-bordered table-sm">
<thead class="table-light">
<tr><th>Collaborateur</th>{% for t in types %}<th>{{ t.nom }}</th>{% endfor %}</tr>
</thead>
    <tbody>
    {% for row in quota_rows %}
    <tr>
      <td>{{ row.user.get_full_name }}</td>
      {% for q in row.quotas %}
        <td>{{ q|default:"â€”" }}</td>
      {% endfor %}
    </tr>
    {% endfor %}
    </tbody>

</table>
</div>

<!-- ================================================= -->
<!-- RECUPERATIONS -->
<!-- ================================================= -->
<div class="tab-pane fade" id="recups">
<table class="table table-bordered table-sm">
<thead class="table-light">
<tr><th>Nom</th><th>Date</th><th>Jours</th><th>Statut</th><th>Action</th></tr>
</thead>
<tbody>
{% for r in recuperations %}
<tr>
<td>{{ r.utilisateur.get_full_name }}</td>
<td>{{ r.date_debut }}</td>
<td>{{ r.nombre_jours }}</td>
<td>{{ r.statut }}</td>
<td>
{% if r.statut == 'en_attente' %}
<a href="{% url 'valider_recuperation' r.id %}" class="btn btn-success btn-sm">VÃ©rifier</a>
{% else %}
â€”
{% endif %}
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

</div>
</div>

<!-- ================= MODALES DRH ================= -->
<!-- ================================================= -->
<!-- MODALES DRH â€“ DEMANDES Ã€ VÃ‰RIFIER -->
<!-- ================================================= -->
{% for absence in absences_a_verifier %}

<!-- ===== MODAL VÃ‰RIFIER ===== -->
<div class="modal fade" id="modalVerifier{{ absence.id }}" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="{% url 'verifier_absence' absence.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">VÃ©rifier lâ€™absence</h5>
        </div>
        <div class="modal-body">
          <p><strong>{{ absence.collaborateur.get_full_name }}</strong></p>
          <p>{{ absence.type_absence.nom }}</p>
          <p>{{ absence.date_debut }} â†’ {{ absence.date_fin }}</p>
          <p><strong>{{ absence.nombre_jours }}</strong> jour(s)</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success">âœ… VÃ©rifier</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ===== MODAL AMÃ‰LIORER ===== -->
<div class="modal fade" id="modalAmeliorer{{ absence.id }}" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="{% url 'modifier_absence_drh' absence.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Demande dâ€™amÃ©lioration</h5>
        </div>
        <div class="modal-body">
          <label>Message Ã  transmettre au collaborateur :</label>
          <textarea name="commentaire" class="form-control" required></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-warning">Envoyer</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ===== MODAL REJETER ===== -->
<div class="modal fade" id="modalRejeter{{ absence.id }}" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="{% url 'rejeter_absence_drh' absence.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Rejeter lâ€™absence</h5>
        </div>
        <div class="modal-body">
          <label>Motif du rejet :</label>
          <textarea name="commentaire" class="form-control" required></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger">Rejeter</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endfor %}
{% for absence in absences_supervision %}
{% if absence.statut == 'valide_dp' %}

<div class="modal fade" id="modalAnnulerDrh{{ absence.id }}" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="{% url 'annuler_absence_drh' absence.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Annulation DRH (dÃ©finitive)</h5>
        </div>
        <div class="modal-body">
          <p>
            <strong>{{ absence.collaborateur.get_full_name }}</strong><br>
            {{ absence.type_absence.nom }}<br>
            {{ absence.date_debut }} â†’ {{ absence.date_fin }}
          </p>

          <label>Motif dâ€™annulation :</label>
          <textarea name="motif" class="form-control" required></textarea>

          <div class="alert alert-warning mt-3">
            âš ï¸ Cette action supprimera dÃ©finitivement lâ€™absence et rÃ©tablira le quota.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger">âŒ Annuler dÃ©finitivement</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endif %}
{% endfor %}


{% endblock %}
